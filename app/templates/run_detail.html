{% extends "layout.html" %}

{% block content %}

<style>
    .run-hero {
        background: linear-gradient(135deg, #0f9b0f, #00b4d8);
        color: #fff;
        border-radius: 1rem;
        padding: 1.25rem 1.75rem;
        margin-top: 1rem;
        margin-bottom: 1.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .run-hero h2 {
        margin: 0;
        font-weight: 600;
    }

    /* === GRAFİK KARTLARI === */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 sütun */
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Tablet / telefonlarda tek sütun */
    @media (max-width: 992px) {
        .charts-container {
            grid-template-columns: 1fr;
        }
    }

    .chart-box {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1rem 1.25rem 1.5rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        min-height: 320px;  /* kartın yüksekliğini biraz arttıralım */
        display: flex;
        flex-direction: column;
    }

    .chart-box h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #1f2933;
    }

    .chart-box canvas {
        width: 100% !important;
        height: 260px !important;  /* grafiğin kendisini büyüt */
        max-height: none;
    }

    .card-header {
        font-weight: 600;
    }
</style>

<div class="run-hero">
    <h2>⚙️ Çalışma Detayı (Run #{{ run.id }})</h2>
</div>

<!-- Run Info -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">Run Bilgileri</div>
    <div class="card-body">
        <p><strong>Model:</strong> {{ run.model_name }}</p>
        <p><strong>Cihaz ID:</strong> {{ run.device_id }}</p>
        <p><strong>Kullanıcı ID:</strong> {{ run.user_id }}</p>
        <p><strong>Başlangıç:</strong> {{ run.started_at }}</p>
        <p><strong>Bitiş:</strong> {{ run.ended_at }}</p>
        <p><strong>Notlar:</strong> {{ run.notes }}</p>
    </div>
</div>

<!-- CANLI GRAFİKLER -->
<h2 class="mb-3">Canlı Ölçümler</h2>

<div class="charts-container">

    <div class="chart-box">
        <h4>CPU Kullanımı (%)</h4>
        <canvas id="cpuChart"></canvas>
    </div>

    <div class="chart-box">
        <h4>GPU Kullanımı (%)</h4>
        <canvas id="gpuChart"></canvas>
    </div>

    <div class="chart-box">
        <h4>RAM Kullanımı (MB)</h4>
        <canvas id="ramChart"></canvas>
    </div>

    <div class="chart-box">
        <h4>Güç Tüketimi (W)</h4>
        <canvas id="powerChart"></canvas>
    </div>

</div>

<!-- ESKİ METRİKLER -->
<div class="card mb-4 mt-4">
    <div class="card-header bg-success text-white">Geçmiş Metrikler</div>
    <div class="card-body">
        {% if metrics %}
        <table class="table table-bordered table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th>Zaman</th>
                    <th>CPU (%)</th>
                    <th>GPU (%)</th>
                    <th>Güç (W)</th>
                    <th>RAM (MB)</th>
                </tr>
            </thead>
            <tbody>
                {% for m in metrics %}
                <tr>
                    <td>{{ m.ts }}</td>
                    <td>{{ m.cpu_util }}</td>
                    <td>{{ m.gpu_util }}</td>
                    <td>{{ m.gpu_power_w }}</td>
                    <td>{{ m.mem_used_mb }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted mb-0">Henüz metrik yok.</p>
        {% endif %}
    </div>
</div>

<!-- Emisyon -->
<div class="card mb-5">
    <div class="card-header bg-warning">Karbon & Enerji</div>
    <div class="card-body">
        {% if emission %}
            <p><strong>Enerji:</strong> {{ emission.energy_kwh }}</p>
            <p><strong>Emisyon:</strong> {{ emission.emission_kg }}</p>
            <p><strong>Bölge:</strong> {{ emission.region_code }}</p>
        {% else %}
            <p class="text-muted mb-0">Henüz emisyon yok.</p>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- RUN ID -->
<script>
    const RUN_ID = "{{ run.id }}";
</script>

<!-- JS -->
<script src="{{ url_for('static', path='run_live.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    startLiveCharts(RUN_ID);
});
</script>

{% endblock %}
