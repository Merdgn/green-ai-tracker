{% extends "base.html" %}

{% block content %}

<style>
    /* === ÃœST BAÅLIK & ğŸ“Š Ä°KON === */
    .pg-icon {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 1.3rem;
        background: radial-gradient(circle at 30% 30%, #ffffff 0, #22c55e 35%, #0284c7 100%);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
        flex: 0 0 auto;
    }

    .page-gradient-header {
        display: flex;
        align-items: center;
        justify-content: flex-start !important; /* SOLA SABÄ°T */
        text-align: left !important;           /* SOLA SABÄ°T */
        gap: 0.75rem;
        background: linear-gradient(135deg, #0284c7, #0f172a);
        padding: 0.8rem 1.2rem;
        border-radius: 1rem;
        color: #f9fafb;
        box-shadow: 0 10px 25px rgba(0,0,0,0.18);
    }

    /* Ãœstte herhangi bir yerden gelen text-center etkisini kÄ±r */
    .page-gradient-header * {
        text-align: left !important;
    }

    .pg-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        gap: 0.15rem;
    }

    .pg-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .pg-subtitle {
        font-size: 0.85rem;
        margin: 0;
        opacity: 0.9;
    }

    /* === BUTONLARI AÃ‡IK GRÄ° (SOFT) YAP === */
    .btn-soft {
        background: #f1f5f9;         /* aÃ§Ä±k gri */
        border: 1px solid #cbd5e1;   /* gri border */
        color: #0f172a;
        font-weight: 600;
        border-radius: 0.75rem;
    }
    .btn-soft:hover {
        background: #e2e8f0;
        border-color: #94a3b8;
        color: #0f172a;
    }
    .btn-soft:focus {
        box-shadow: 0 0 0 0.2rem rgba(148,163,184,0.35);
    }

    /* input-group iÃ§inde buton kÃ¶ÅŸeleri daha temiz dursun */
    .input-group .btn-soft {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* === ÃœSTTEKÄ° 2 KART === */
    .dash-card {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.15);
        overflow: hidden;
    }

    .dash-card-header {
        padding: 0.65rem 1rem;
        background: linear-gradient(135deg, #283a66, #9ca3af);
        color: #f9fafb;
        font-weight: 600;
        font-size: 0.92rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .dash-card-body {
        background: radial-gradient(circle at top left, #ecfdf5 0, #f9fafb 45%, #eff6ff 100%);
        padding: 0.9rem 1.2rem 1.1rem;
    }

    /* === 8â€™LÄ° Ä°STATÄ°STÄ°K ÅERÄ°DÄ° === */
    .stats-strip {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.75rem;
        overflow-x: auto;
        padding: 0.2rem 0 0.35rem;
    }

    .stats-strip::-webkit-scrollbar { height: 4px; }
    .stats-strip::-webkit-scrollbar-track { background: transparent; }
    .stats-strip::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.7);
        border-radius: 999px;
    }

    .stat-chip {
        position: relative;
        min-width: 190px;
        max-width: 220px;
        background: #ffffff;
        border-radius: 0.9rem;
        border: 1px solid #e5e7eb;
        padding: 0.55rem 0.8rem 0.65rem;
        box-shadow: 0 5px 16px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-chip::before {
        content: "";
        position: absolute;
        left: 0;
        top: 6px;
        bottom: 6px;
        width: 3px;
        border-radius: 999px;
        background: var(--stat-grad, linear-gradient(180deg, #0ea5e9, #22c55e));
    }

    .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        margin-left: 4px;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-left: 4px;
        margin-top: 0.1rem;
    }

    .stat-sub {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-left: 4px;
        margin-top: 0.05rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .stat-small {
        font-size: 0.9rem;
        font-weight: 600;
        color: #111827;
    }

    .stat-users       { --stat-grad: linear-gradient(180deg, #3b82f6, #22c55e); }
    .stat-devices     { --stat-grad: linear-gradient(180deg, #22c55e, #16a34a); }
    .stat-runs        { --stat-grad: linear-gradient(180deg, #f97316, #fb923c); }
    .stat-metrics     { --stat-grad: linear-gradient(180deg, #a855f7, #6366f1); }
    .stat-emission    { --stat-grad: linear-gradient(180deg, #fb7185, #ec4899); }
    .stat-avg-energy  { --stat-grad: linear-gradient(180deg, #22c55e, #0ea5e9); }
    .stat-top-emitter { --stat-grad: linear-gradient(180deg, #6366f1, #ec4899); }
    .stat-popular     { --stat-grad: linear-gradient(180deg, #0f172a, #111827); }

    /* === GRAFÄ°K KARTLARI === */
    .chart-card {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
        overflow: hidden;
        background: #ffffff;
    }

    .chart-card-header {
        padding: 0.6rem 1rem;
        background: linear-gradient(135deg, #283a66, #94a3b8);
        color: #f9fafb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .chart-card-body {
        background: radial-gradient(circle at top, #eff6ff 0, #f9fafb 45%, #ecfdf5 100%);
        padding: 0.9rem 1.2rem 1.1rem;
    }

    .badge-live {
        background: rgba(15, 23, 42, 0.15);
        border-radius: 999px;
        padding: 0.2rem 0.7rem;
        font-size: 0.7rem;
        font-weight: 500;
    }

    /* === SON 5 RUN TABLOSU === */
    .last-runs-card {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
        overflow: hidden;
        margin-top: 1.3rem;
    }

    .last-runs-header {
        padding: 0.7rem 1rem;
        background: linear-gradient(135deg, #283a66, #0ea5e9);
        color: #f9fafb;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .recent-table-head {
        background: linear-gradient(90deg, #0b1120, #111827);
        color: #f9fafb;
    }

    .recent-table-head th {
        border-color: transparent !important;
        font-weight: 500;
        font-size: 0.85rem;
    }
</style>

<!-- ÃœST BAÅLIK (SOLA HÄ°ZALI) -->
<div class="page-gradient-header mb-4">
    <div class="pg-icon">ğŸ“Š</div>
    <div class="pg-text">
        <h1 class="pg-title">Dashboard Genel Ä°statistikler</h1>
        <p class="pg-subtitle">
            Modellerinizin enerji, emisyon ve sistem yÃ¼kÃ¼nÃ¼ tek ekrandan takip edin.
        </p>
    </div>
</div>

<!-- ÃœST KARTLAR -->
<div class="row g-3 mb-3">
    <!-- Sistem CanlÄ± Ä°zleme -->
    <div class="col-md-6">
        <div class="card dash-card h-100">
            <div class="dash-card-header">
                <span>ğŸ–¥ï¸ Sistem CanlÄ± Ä°zleme</span>
            </div>
            <div class="dash-card-body d-flex flex-column">
                <p class="text-muted mb-3">
                    TÃ¼m CPU / GPU / RAM Ã¶lÃ§Ã¼mlerini gerÃ§ek zamanlÄ± olarak takip edin.
                </p>
                <a href="/monitor" class="btn btn-soft mt-auto w-100">
                    CanlÄ± Ä°zleme Paneli
                </a>
            </div>
        </div>
    </div>

    <!-- Run ID ile CanlÄ± Ä°zleme -->
    <div class="col-md-6">
        <div class="card dash-card h-100">
            <div class="dash-card-header">
                <span>ğŸ§  Run ID ile CanlÄ± Ä°zleme</span>
            </div>
            <div class="dash-card-body d-flex flex-column">
                <p class="text-muted mb-3">
                    Belirli bir run iÃ§in detaylÄ± metrik grafiÄŸini gÃ¶rÃ¼ntÃ¼leyin.
                </p>
                <div class="input-group mt-auto">
                    <input id="runIdInput" type="number" class="form-control" placeholder="Run ID gir" />
                    <button id="runIdGoBtn" class="btn btn-soft">Ä°ncele</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SADE 8â€™LÄ° Ä°STATÄ°STÄ°K ÅERÄ°DÄ° -->
<div id="stats-row" class="stats-strip mb-4">
    <!-- JS dolduracak -->
</div>

<!-- ORTALAMA GRAFÄ°KLER -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="chart-card-header">
                <span>CPU Ortalama (%)</span>
                <span class="badge-live">Genel ortalama</span>
            </div>
            <div class="chart-card-body">
                <canvas id="cpuChart" style="height:260px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card chart-card">
            <div class="chart-card-header">
                <span>GPU Ortalama (%)</span>
                <span class="badge-live">Genel ortalama</span>
            </div>
            <div class="chart-card-body">
                <canvas id="gpuChart" style="height:260px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- SON 5 RUN -->
<div class="card last-runs-card">
    <div class="last-runs-header">
        Son 5 Run
    </div>
    <div class="card-body p-0">
        <table class="table mb-0 align-middle" id="recentRunsTable">
            <thead class="recent-table-head">
                <tr>
                    <th>ID</th>
                    <th>Model</th>
                    <th>KullanÄ±cÄ±</th>
                    <th>BaÅŸlangÄ±Ã§</th>
                    <th>BitiÅŸ</th>
                    <th class="text-center">Ä°ncele</th>
                </tr>
            </thead>
            <tbody>
                <!-- JS ile doldurulacak -->
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function formatDateTime(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);
    const pad = (n) => String(n).padStart(2, "0");
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const h = pad(d.getHours());
    const min = pad(d.getMinutes());
    const s = pad(d.getSeconds());
    return `${y}-${m}-${day} ${h}:${min}:${s}`;
}

fetch("/dashboard/stats")
    .then(res => res.json())
    .then((data) => {
        const statsRow = document.getElementById("stats-row");

        const avgEnergy = data.avg_energy_per_model_kwh ?? 0;
        const topEmitter = data.top_emitter_model ?? {};
        const topEmitterText = topEmitter.name
            ? `${topEmitter.name} (${(topEmitter.total_emission_kg ?? 0).toFixed(4)} kg)`
            : "-";

        statsRow.innerHTML = `
            <div class="stat-chip stat-users">
                <span class="stat-label">KullanÄ±cÄ±</span>
                <span class="stat-value">${data.total_users}</span>
                <span class="stat-sub">Toplam kullanÄ±cÄ± sayÄ±sÄ±</span>
            </div>
            <div class="stat-chip stat-devices">
                <span class="stat-label">Cihaz</span>
                <span class="stat-value">${data.total_devices}</span>
                <span class="stat-sub">Aktif cihaz sayÄ±sÄ±</span>
            </div>
            <div class="stat-chip stat-runs">
                <span class="stat-label">Run</span>
                <span class="stat-value">${data.total_runs}</span>
                <span class="stat-sub">Toplam run sayÄ±sÄ±</span>
            </div>
            <div class="stat-chip stat-metrics">
                <span class="stat-label">Metrik</span>
                <span class="stat-value">${data.total_metrics}</span>
                <span class="stat-sub">Toplanan Ã¶lÃ§Ã¼m</span>
            </div>
            <div class="stat-chip stat-emission">
                <span class="stat-label">Emisyon (kg)</span>
                <span class="stat-value">${data.total_emission_kg.toFixed(4)}</span>
                <span class="stat-sub">Toplam COâ‚‚e</span>
            </div>
            <div class="stat-chip stat-avg-energy">
                <span class="stat-label">Model BaÅŸÄ±na Ortalama Enerji</span>
                <span class="stat-value">${avgEnergy.toFixed(6)}</span>
                <span class="stat-sub">kWh cinsinden</span>
            </div>
            <div class="stat-chip stat-top-emitter">
                <span class="stat-label">En Ã‡ok Emisyon Ãœreten Model</span>
                <span class="stat-value stat-small">${topEmitterText}</span>
                <span class="stat-sub">Toplam emisyona gÃ¶re</span>
            </div>
            <div class="stat-chip stat-popular">
                <span class="stat-label">PopÃ¼ler Model</span>
                <span class="stat-value stat-small">${data.popular_model?.name ?? "-"}</span>
                <span class="stat-sub">En sÄ±k kullanÄ±lan model</span>
            </div>
        `;

        new Chart(document.getElementById("cpuChart"), {
            type: "line",
            data: {
                labels: ["CPU Ortalama"],
                datasets: [{
                    label: "CPU (%)",
                    data: [data.avg_cpu],
                    borderColor: "#0d6efd",
                    backgroundColor: "rgba(13,110,253,0.15)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 100, ticks: { stepSize: 20 } }, x: { display: false } }
            }
        });

        new Chart(document.getElementById("gpuChart"), {
            type: "line",
            data: {
                labels: ["GPU Ortalama"],
                datasets: [{
                    label: "GPU (%)",
                    data: [data.avg_gpu],
                    borderColor: "#22c55e",
                    backgroundColor: "rgba(34,197,94,0.18)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 100, ticks: { stepSize: 20 } }, x: { display: false } }
            }
        });

        let tbody = "";
        (data.recent_runs || []).forEach(r => {
            tbody += `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.model_name}</td>
                    <td>${r.user_id}</td>
                    <td>${formatDateTime(r.started_at)}</td>
                    <td>${formatDateTime(r.ended_at)}</td>
                    <td class="text-center">
                        <a class="btn btn-outline-primary btn-sm" href="/run/${r.id}">Ä°ncele</a>
                    </td>
                </tr>
            `;
        });
        document.querySelector("#recentRunsTable tbody").innerHTML = tbody;
    })
    .catch(err => console.error("Dashboard verisi alÄ±nÄ±rken hata:", err));

document.getElementById("runIdGoBtn").addEventListener("click", () => {
    const val = document.getElementById("runIdInput").value;
    if (!val) return;
    window.location.href = `/run/${val}`;
});
</script>

{% endblock %}
