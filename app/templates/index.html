{% extends "layout.html" %}

{% block content %}

<div class="container mt-4">

    <h2 class="mb-4">Dashboard Genel Ä°statistikler</h2>

    <!-- ÃœST KARTLAR -->
    <div class="row g-3 mb-4">
        <!-- Sistem CanlÄ± Ä°zleme -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">ğŸ–¥ï¸ Sistem CanlÄ± Ä°zleme</h5>
                    <p class="card-text text-muted">
                        TÃ¼m CPU / GPU / RAM Ã¶lÃ§Ã¼mlerini gerÃ§ek zamanlÄ± izle
                    </p>
                    <a href="/monitor" class="btn btn-primary w-100">CanlÄ± Ä°zleme Paneli</a>
                </div>
            </div>
        </div>

        <!-- Run ID ile CanlÄ± Ä°zleme -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">ğŸ§  Run ID ile CanlÄ± Ä°zleme</h5>
                    <p class="card-text text-muted">
                        Belirli bir Ã§alÄ±ÅŸmanÄ±n detay ve canlÄ± grafiÄŸini gÃ¶rÃ¼ntÃ¼le
                    </p>
                    <div class="input-group">
                        <input id="runIdInput" type="number" class="form-control" placeholder="Run ID gir" />
                        <button id="runIdGoBtn" class="btn btn-success">Ä°ncele</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== KARTLAR ===== -->
    <div id="stats-cards" class="row g-3 mb-4">
        <!-- JS ile doldurulacak -->
    </div>

    <!-- ===== CPU / GPU ORTALAMA GRAFÄ°KLER ===== -->
    <div class="row mb-5">
        <div class="col-md-6">
            <canvas id="cpuChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="gpuChart"></canvas>
        </div>
    </div>

    <!-- ===== SON 5 RUN ===== -->
    <h3>Son 5 Run</h3>
    <table class="table table-striped mb-5" id="recentRunsTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Model</th>
                <th>KullanÄ±cÄ±</th>
                <th>BaÅŸlangÄ±Ã§</th>
                <th>Ä°ncele</th>
            </tr>
        </thead>
        <tbody>
            <!-- JS ile doldurulacak -->
        </tbody>
    </table>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Dashboard API'den veriyi Ã§ek
fetch("/dashboard/stats")
    .then(res => res.json())
    .then(data => {

        // ==== KARTLARI YAZDIR ====
        document.getElementById("stats-cards").innerHTML = `
            <div class="col-md-2"><div class="card p-3 bg-primary text-white"><h5>KullanÄ±cÄ±</h5><h3>${data.total_users}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-success text-white"><h5>Cihaz</h5><h3>${data.total_devices}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-info text-white"><h5>Run</h5><h3>${data.total_runs}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-warning text-white"><h5>Metrik</h5><h3>${data.total_metrics}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-danger text-white"><h5>Emisyon (kg)</h5><h3>${data.total_emission_kg.toFixed(4)}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-dark text-white"><h5>PopÃ¼ler Model</h5><h4>${data.popular_model.name ?? "-"}</h4></div></div>
        `;

        // ==== CPU GRAFÄ°K ====
        new Chart(document.getElementById("cpuChart"), {
            type: "line",
            data: {
                labels: ["CPU Ortalama"],
                datasets: [{
                    label: "CPU (%)",
                    data: [data.avg_cpu],
                    borderColor: "blue",
                    borderWidth: 2
                }]
            }
        });

        // ==== GPU GRAFÄ°K ====
        new Chart(document.getElementById("gpuChart"), {
            type: "line",
            data: {
                labels: ["GPU Ortalama"],
                datasets: [{
                    label: "GPU (%)",
                    data: [data.avg_gpu],
                    borderColor: "red",
                    borderWidth: 2
                }]
            }
        });

        // ==== SON 5 RUN TABLOSU ====
        let tbody = "";
        data.recent_runs.forEach(r => {
            tbody += `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.model_name}</td>
                    <td>${r.user_id}</td>
                    <td>${r.started_at}</td>
                    <td>
                        <a class="btn btn-primary btn-sm" href="/run/${r.id}">Ä°ncele</a>
                    </td>
                </tr>
            `;
        });
        document.querySelector("#recentRunsTable tbody").innerHTML = tbody;

    });

// Run ID input -> Ä°ncele butonu
document.getElementById("runIdGoBtn").addEventListener("click", () => {
    const val = document.getElementById("runIdInput").value;
    if (!val) return;
    window.location.href = `/run/${val}`;
});
</script>

{% endblock %}
