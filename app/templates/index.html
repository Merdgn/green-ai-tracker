{% extends "base.html" %}

{% block content %}

<!-- ÃœST BÃœYÃœK GRADIENT BAÅLIK -->
<div class="page-gradient-header mb-4">
    <div class="pg-icon">
        ğŸ“Š
    </div>
    <div>
        <h1 class="pg-title">Dashboard Genel Ä°statistikler</h1>
        <p class="pg-subtitle">
            Modellerinizin enerji, emisyon ve sistem yÃ¼kÃ¼nÃ¼ tek ekrandan takip edin.
        </p>
    </div>
</div>

<!-- ÃœST KARTLAR -->
<div class="row g-3 mb-3">
    <!-- Sistem CanlÄ± Ä°zleme -->
    <div class="col-md-6">
        <div class="card dash-card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-1">ğŸ–¥ï¸ Sistem CanlÄ± Ä°zleme</h5>
                <p class="card-text text-muted mb-3">
                    TÃ¼m CPU / GPU / RAM Ã¶lÃ§Ã¼mlerini gerÃ§ek zamanlÄ± olarak takip edin.
                </p>
                <a href="/monitor" class="btn btn-primary mt-auto w-100">
                    CanlÄ± Ä°zleme Paneli
                </a>
            </div>
        </div>
    </div>

    <!-- Run ID ile CanlÄ± Ä°zleme -->
    <div class="col-md-6">
        <div class="card dash-card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-1">ğŸ§  Run ID ile CanlÄ± Ä°zleme</h5>
                <p class="card-text text-muted mb-3">
                    Belirli bir run iÃ§in detaylÄ± metrik grafiÄŸini gÃ¶rÃ¼ntÃ¼leyin.
                </p>
                <div class="input-group mt-auto">
                    <input id="runIdInput" type="number" class="form-control" placeholder="Run ID gir" />
                    <button id="runIdGoBtn" class="btn btn-success">Ä°ncele</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- RENKLÄ° KÃœÃ‡ÃœK Ä°STATÄ°STÄ°K KARTLARI -->
<div id="stats-grid" class="stats-grid mb-4">
    <!-- JS dolduracak -->
</div>

<!-- ORTALAMA GRAFÄ°KLER -->
<div class="row g-3 mb-5">
    <div class="col-md-6">
        <div class="card dash-card">
            <div class="dash-card-header">
                <h5 class="mb-0">CPU Ortalama (%)</h5>
                <span class="badge badge-live">Genel ortalama</span>
            </div>
            <div class="dash-card-body">
                <canvas id="cpuChart" style="height:260px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card dash-card">
            <div class="dash-card-header">
                <h5 class="mb-0">GPU Ortalama (%)</h5>
                <span class="badge badge-live">Genel ortalama</span>
            </div>
            <div class="dash-card-body">
                <canvas id="gpuChart" style="height:260px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- SON 5 RUN -->
<h3 class="section-title mb-2">Son 5 Run</h3>
<div class="card dash-card">
    <div class="card-body p-0">
        <table class="table mb-0 align-middle" id="recentRunsTable">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Model</th>
                    <th>KullanÄ±cÄ±</th>
                    <th>BaÅŸlangÄ±Ã§</th>
                    <th>BitiÅŸ</th>
                    <th class="text-center">Ä°ncele</th>
                </tr>
            </thead>
            <tbody>
                <!-- JS ile doldurulacak -->
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ISO tarih -> "YYYY-MM-DD HH:MM:SS"
function formatDateTime(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso); // parse edemezse olduÄŸu gibi gÃ¶ster

    const pad = (n) => String(n).padStart(2, "0");
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const h = pad(d.getHours());
    const min = pad(d.getMinutes());
    const s = pad(d.getSeconds());
    return `${y}-${m}-${day} ${h}:${min}:${s}`;
}

// Dashboard API'den veriyi Ã§ek
fetch("/dashboard/stats")
    .then(res => res.json())
    .then((data) => {
        // =========================
        // RENKLÄ° KÃœÃ‡ÃœK KARTLAR
        // =========================
        document.getElementById("stats-grid").innerHTML = `
            <div class="stat-card stat-users">
                <span class="stat-label">KullanÄ±cÄ±</span>
                <span class="stat-value">${data.total_users}</span>
            </div>
            <div class="stat-card stat-devices">
                <span class="stat-label">Cihaz</span>
                <span class="stat-value">${data.total_devices}</span>
            </div>
            <div class="stat-card stat-runs">
                <span class="stat-label">Run</span>
                <span class="stat-value">${data.total_runs}</span>
            </div>
            <div class="stat-card stat-metrics">
                <span class="stat-label">Metrik</span>
                <span class="stat-value">${data.total_metrics}</span>
            </div>
            <div class="stat-card stat-emission">
                <span class="stat-label">Emisyon (kg)</span>
                <span class="stat-value">${data.total_emission_kg.toFixed(4)}</span>
            </div>
            <div class="stat-card stat-popular">
                <span class="stat-label">PopÃ¼ler Model</span>
                <span class="stat-value stat-small">${data.popular_model.name ?? "-"}</span>
            </div>
        `;

        // =========================
        // CPU GRAFÄ°ÄÄ° (0â€“100 arasÄ±, ortalÄ±)
        // =========================
        new Chart(document.getElementById("cpuChart"), {
            type: "line",
            data: {
                labels: ["CPU Ortalama"],
                datasets: [{
                    label: "CPU (%)",
                    data: [data.avg_cpu],
                    borderColor: "#0d6efd",
                    backgroundColor: "rgba(13,110,253,0.15)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: { stepSize: 20 }
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        // =========================
        // GPU GRAFÄ°ÄÄ° (0â€“100 arasÄ±, ortalÄ±)
        // =========================
        new Chart(document.getElementById("gpuChart"), {
            type: "line",
            data: {
                labels: ["GPU Ortalama"],
                datasets: [{
                    label: "GPU (%)",
                    data: [data.avg_gpu],
                    borderColor: "#dc3545",
                    backgroundColor: "rgba(220,53,69,0.15)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: { stepSize: 20 }
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        // =========================
        // SON 5 RUN TABLOSU
        // (backend'den gelen started_at & ended_at kullanÄ±lÄ±yor)
        // =========================
        let tbody = "";
        (data.recent_runs || []).forEach(r => {
            const started = formatDateTime(r.started_at);
            const ended   = formatDateTime(r.ended_at);

            tbody += `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.model_name}</td>
                    <td>${r.user_id}</td>
                    <td>${started}</td>
                    <td>${ended}</td>
                    <td class="text-center">
                        <a class="btn btn-outline-primary btn-sm" href="/run/${r.id}">Ä°ncele</a>
                    </td>
                </tr>
            `;
        });
        document.querySelector("#recentRunsTable tbody").innerHTML = tbody;
    });

// Run ID input -> Ä°ncele butonu
document.getElementById("runIdGoBtn").addEventListener("click", () => {
    const val = document.getElementById("runIdInput").value;
    if (!val) return;
    window.location.href = `/run/${val}`;
});
</script>

{% endblock %}
