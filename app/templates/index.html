{% extends "layout.html" %}

{% block content %}

<div class="page-gradient-header">
    <h2>Dashboard Genel Ä°statistikler</h2>
    <p>Modellerinizin enerji ve emisyon durumunu tek ekrandan takip edin.</p>
</div>

<div class="container mb-5">

    <!-- ÃœST KARTLAR -->
    <div class="row g-3 mb-4">
        <!-- Sistem CanlÄ± Ä°zleme -->
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-body">
                    <h5 class="card-title mb-1">ğŸ–¥ï¸ Sistem CanlÄ± Ä°zleme</h5>
                    <p class="card-text text-muted mb-3">
                        TÃ¼m CPU / GPU / RAM Ã¶lÃ§Ã¼mlerini gerÃ§ek zamanlÄ± izle.
                    </p>
                    <a href="/monitor" class="btn btn-primary w-100">CanlÄ± Ä°zleme Paneli</a>
                </div>
            </div>
        </div>

        <!-- Run ID ile CanlÄ± Ä°zleme -->
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-body">
                    <h5 class="card-title mb-1">ğŸ§  Run ID ile CanlÄ± Ä°zleme</h5>
                    <p class="card-text text-muted mb-3">
                        Belirli bir Ã§alÄ±ÅŸmanÄ±n detay ve canlÄ± grafiÄŸini gÃ¶rÃ¼ntÃ¼le.
                    </p>
                    <div class="input-group">
                        <input id="runIdInput" type="number" class="form-control" placeholder="Run ID gir" />
                        <button id="runIdGoBtn" class="btn btn-success">Ä°ncele</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ä°STATÄ°STÄ°K KARTLAR -->
    <div id="stats-cards" class="row g-3 mb-4">
        <!-- JS ile doldurulacak -->
    </div>

    <!-- ORTALAMA GRAFÄ°KLER -->
    <div class="row g-3 mb-5">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="chart-card-header">
                    <h5>CPU Ortalama (%)</h5>
                    <span class="badge badge-live text-white">Genel ortalama</span>
                </div>
                <div class="chart-card-body">
                    <canvas id="cpuChart" style="height:260px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="chart-card-header">
                    <h5>GPU Ortalama (%)</h5>
                    <span class="badge badge-live text-white">Genel ortalama</span>
                </div>
                <div class="chart-card-body">
                    <canvas id="gpuChart" style="height:260px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- SON 5 RUN -->
    <h3 class="section-title">Son 5 Run</h3>
    <div class="card chart-card">
        <div class="card-body p-0">
            <table class="table mb-0" id="recentRunsTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Model</th>
                        <th>KullanÄ±cÄ±</th>
                        <th>BaÅŸlangÄ±Ã§</th>
                        <th>Ä°ncele</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Dashboard API'den veriyi Ã§ek
fetch("/dashboard/stats")
    .then(res => res.json())
    .then(data => {

        // ==== KARTLARI YAZDIR ====
        document.getElementById("stats-cards").innerHTML = `
            <div class="col-md-2"><div class="card p-3 bg-primary text-white text-center"><h6>KullanÄ±cÄ±</h6><h3>${data.total_users}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-success text-white text-center"><h6>Cihaz</h6><h3>${data.total_devices}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-info text-white text-center"><h6>Run</h6><h3>${data.total_runs}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-warning text-white text-center"><h6>Metrik</h6><h3>${data.total_metrics}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-danger text-white text-center"><h6>Emisyon (kg)</h6><h3>${data.total_emission_kg.toFixed(4)}</h3></div></div>
            <div class="col-md-2"><div class="card p-3 bg-dark text-white text-center"><h6>PopÃ¼ler Model</h6><h5 class="mb-0">${data.popular_model.name ?? "-"}</h5></div></div>
        `;

        // ==== CPU GRAFÄ°K ====
        new Chart(document.getElementById("cpuChart"), {
            type: "line",
            data: {
                labels: ["CPU Ortalama"],
                datasets: [{
                    label: "CPU (%)",
                    data: [data.avg_cpu],
                    borderColor: "#0984e3",
                    backgroundColor: "rgba(9,132,227,0.15)",
                    borderWidth: 2,
                    tension: 0.2,
                    fill: true
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // ==== GPU GRAFÄ°K ====
        new Chart(document.getElementById("gpuChart"), {
            type: "line",
            data: {
                labels: ["GPU Ortalama"],
                datasets: [{
                    label: "GPU (%)",
                    data: [data.avg_gpu],
                    borderColor: "#d63031",
                    backgroundColor: "rgba(214,48,49,0.15)",
                    borderWidth: 2,
                    tension: 0.2,
                    fill: true
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // ==== SON 5 RUN TABLOSU ====
        let tbody = "";
        data.recent_runs.forEach(r => {
            tbody += `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.model_name}</td>
                    <td>${r.user_id}</td>
                    <td>${r.started_at}</td>
                    <td>
                        <a class="btn btn-primary btn-sm" href="/run/${r.id}">Ä°ncele</a>
                    </td>
                </tr>
            `;
        });
        document.querySelector("#recentRunsTable tbody").innerHTML = tbody;
    });

// Run ID input -> Ä°ncele butonu
document.getElementById("runIdGoBtn").addEventListener("click", () => {
    const val = document.getElementById("runIdInput").value;
    if (!val) return;
    window.location.href = `/run/${val}`;
});
</script>

{% endblock %}
